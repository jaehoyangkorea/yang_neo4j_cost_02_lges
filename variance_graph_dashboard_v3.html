<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ì›ê°€ì°¨ì´ ë¶„ì„ v4 (<?php echo time(); ?>)</title>
    
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard {
            display: flex;
            height: 100vh;
        }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .sidebar-header .status {
            font-size: 11px;
            display: inline-block;
            padding: 3px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
        }
        
        .sidebar-header .status.connected {
            background: #27ae60;
        }
        
        .sidebar-header .status.disconnected {
            background: #e74c3c;
        }
        
        /* í•„í„° ì„¹ì…˜ */
        .filter-section {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .filter-group {
            margin-bottom: 6px;
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
        }
        
        .filter-group label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 3px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 11px;
            background: white;
        }
        
        .btn-filter {
            width: 100%;
            padding: 7px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .btn-filter:hover {
            background: #2980b9;
        }
        
        /* ë…¸ë“œ íƒ€ì… ì„ íƒ ë²„íŠ¼ */
        .node-type-btn {
            flex: 1;
            padding: 6px;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .node-type-btn:hover {
            background: #dee2e6;
        }
        
        .node-type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* ì„ íƒ ë²„íŠ¼ */
        .item-btn {
            padding: 8px 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .item-btn:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(33,150,243,0.3);
        }
        
        .item-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        /* ì „ì²´ ì›ê°€ì°¨ì´ */
        .total-section {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
        }
        
        .total-section h2 {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .total-section .amount {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .total-section .count {
            font-size: 11px;
            opacity: 0.8;
        }
        
        /* ì°¨ì´ ìœ í˜• ì„¹ì…˜ */
        .variance-types {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .variance-category {
            margin-bottom: 8px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .category-header {
            padding: 10px 12px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .category-header:hover {
            background: #e9ecef;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .category-icon {
            font-size: 10px;
            transition: transform 0.3s;
        }
        
        .category-icon.expanded {
            transform: rotate(90deg);
        }
        
        .category-amount {
            font-size: 13px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .category-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
        }
        
        .category-items.show {
            max-height: 600px;
        }
        
        .order-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item:hover {
            background: #f1f8ff;
            transform: translateX(3px);
        }
        
        .order-item.selected {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }
        
        .order-no {
            font-weight: 600;
            color: #0366d6;
            font-size: 12px;
            margin-bottom: 3px;
        }
        
        .order-detail {
            font-size: 10px;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .order-amount {
            font-size: 12px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        /* ê·¸ë˜í”„ ì˜ì—­ */
        .graph-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            position: relative;
            min-height: 100vh;
        }
        
        .graph-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .graph-header h2 {
            font-size: 16px;
            color: #2c3e50;
        }
        
        .graph-info {
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .graph-controls {
            display: flex;
            gap: 8px;
        }
        
        .btn-graph-control {
            padding: 6px 12px;
            background: #ffffff;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .btn-graph-control:hover {
            background: #f8f9fa;
            border-color: #666;
        }
        
        .btn-graph-control:active {
            transform: scale(0.95);
        }
        
        #mynetwork {
            flex: 1;
            background: #fafafa;
            width: 100%;
            min-height: 600px;
            height: 100%;
        }
        
        
        /* ë¡œë”© */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #7f8c8d;
            display: none;
            z-index: 1000;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <!-- í—¤ë” -->
            <div class="sidebar-header">
                <h1>ì›ê°€ì°¨ì´ ë¶„ì„</h1>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button onclick="window.location.href='dashboard.html'" style="padding: 5px 10px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ  í™ˆ</button>
                    <button onclick="window.location.href='comparison.html'" style="padding: 5px 10px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ“Š ë¹„êµ</button>
                </div>
                <span class="status" id="statusBadge">í™•ì¸ì¤‘...</span>
            </div>
            
            <!-- í•„í„° ì„¹ì…˜ -->
            <div class="filter-section">
                <div class="filter-group">
                    <label>ê·¸ë˜í”„ ì‹œì‘ ë…¸ë“œ ì„ íƒ</label>
                    <div style="display: flex; gap: 4px; margin-bottom: 10px;">
                        <button class="node-type-btn active" data-type="product" onclick="switchNodeType('product')">ì œí’ˆ</button>
                        <button class="node-type-btn" data-type="material" onclick="switchNodeType('material')">ì›ìì¬</button>
                        <button class="node-type-btn" data-type="workcenter" onclick="switchNodeType('workcenter')">ê³µì •</button>
                    </div>
                </div>
                
                <!-- ì œí’ˆ ë²„íŠ¼ ëª©ë¡ -->
                <div class="filter-group" id="productButtonsContainer">
                    <label>ì œí’ˆ ì„ íƒ (í´ë¦­ ì‹œ ê·¸ë˜í”„ í‘œì‹œ)</label>
                    <div id="productButtons" style="display: flex; flex-wrap: wrap; gap: 5px; max-height: 250px; overflow-y: auto; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        <div style="text-align: center; width: 100%; padding: 20px; color: #999;">ë¡œë”©ì¤‘...</div>
                    </div>
                </div>
                
                <!-- ì›ìì¬ ë²„íŠ¼ ëª©ë¡ -->
                <div class="filter-group" id="materialButtonsContainer" style="display: none;">
                    <label>ì›ìì¬ ì„ íƒ (í´ë¦­ ì‹œ ê·¸ë˜í”„ í‘œì‹œ)</label>
                    <div id="materialButtons" style="display: flex; flex-wrap: wrap; gap: 5px; max-height: 250px; overflow-y: auto; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        <div style="text-align: center; width: 100%; padding: 20px; color: #999;">ë¡œë”©ì¤‘...</div>
                    </div>
                </div>
                
                <!-- ê³µì • ë²„íŠ¼ ëª©ë¡ -->
                <div class="filter-group" id="workcenterButtonsContainer" style="display: none;">
                    <label>ê³µì • ì„ íƒ (í´ë¦­ ì‹œ ê·¸ë˜í”„ í‘œì‹œ)</label>
                    <div id="workcenterButtons" style="display: flex; flex-wrap: wrap; gap: 5px; max-height: 250px; overflow-y: auto; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                        <div style="text-align: center; width: 100%; padding: 20px; color: #999;">ë¡œë”©ì¤‘...</div>
                    </div>
                </div>
            </div>
            
            <!-- ì „ì²´ ì›ê°€ì°¨ì´ -->
            <div class="total-section">
                <h2>ì „ì²´ ì›ê°€ì°¨ì´</h2>
                <div class="amount" id="totalAmount">-</div>
                <div class="count" id="totalCount">-</div>
            </div>
            
            <!-- ì°¨ì´ ìœ í˜•ë³„ -->
            <div class="variance-types">
                <div class="variance-category">
                    <div class="category-header" onclick="toggleCategory('quantity')">
                        <div class="category-title">
                            <span class="category-icon" id="iconQuantity">â–¶</span>
                            <span>ì¬ë£Œë¹„ì°¨ì´ (MATERIAL)</span>
                        </div>
                        <span class="category-amount" id="amountQuantity">-</span>
                    </div>
                    <div class="category-items" id="itemsQuantity">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="variance-category">
                    <div class="category-header" onclick="toggleCategory('price')">
                        <div class="category-title">
                            <span class="category-icon" id="iconPrice">â–¶</span>
                            <span>ë…¸ë¬´ë¹„ì°¨ì´ (LABOR)</span>
                        </div>
                        <span class="category-amount" id="amountPrice">-</span>
                    </div>
                    <div class="category-items" id="itemsPrice">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
                
                <div class="variance-category">
                    <div class="category-header" onclick="toggleCategory('production')">
                        <div class="category-title">
                            <span class="category-icon" id="iconProduction">â–¶</span>
                            <span>ê²½ë¹„ì°¨ì´ (OVERHEAD)</span>
                        </div>
                        <span class="category-amount" id="amountProduction">-</span>
                    </div>
                    <div class="category-items" id="itemsProduction">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ê·¸ë˜í”„ ì˜ì—­ -->
        <div class="graph-container">
            <div class="graph-header">
                <h2 id="graphTitle">ì›ê°€ì°¨ì´ ê·¸ë˜í”„</h2>
                <div class="graph-controls">
                    <button class="btn-graph-control" onclick="resetToInitial()" title="ì²˜ìŒ ìƒíƒœë¡œ">â†º ì´ˆê¸°í™”</button>
                    <button class="btn-graph-control" onclick="focusSelection()" title="ì„ íƒí•œ ë…¸ë“œë§Œ ë³´ê¸°">ğŸ” í¬ì»¤ìŠ¤</button>
                </div>
            </div>
            <div id="mynetwork"></div>
            
            <!-- ë¡œë”© -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>ë°ì´í„° ë¡œë”©ì¤‘...</div>
            </div>
            
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api';
        let network;
        let nodes, edges;
        let currentFilters = { product: '', material: '', workcenter: '', period: '' };
        let expandedCategories = new Set();
        let startNodeType = 'product'; // 'order', 'product', 'material', 'workcenter'
        let selectedItem = null; // í˜„ì¬ ì„ íƒëœ í•­ëª©
        
        // ë…¸ë“œ íƒ€ì… ì „í™˜
        function switchNodeType(type) {
            startNodeType = type;
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.node-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
            
            // ì»¨í…Œì´ë„ˆ í‘œì‹œ/ìˆ¨ê¹€
            document.getElementById('productButtonsContainer').style.display = (type === 'product') ? 'block' : 'none';
            document.getElementById('materialButtonsContainer').style.display = (type === 'material') ? 'block' : 'none';
            document.getElementById('workcenterButtonsContainer').style.display = (type === 'workcenter') ? 'block' : 'none';
            
            // í¼ì³ì§„ ì¹´í…Œê³ ë¦¬ ìƒˆë¡œê³ ì¹¨
            for (const category of expandedCategories) {
                loadCategoryItems(category);
            }
        }
        
        // í•­ëª© ì„ íƒ ë° ê·¸ë˜í”„ ë¡œë“œ
        async function selectItem(type, value) {
            console.log('=== í•­ëª© ì„ íƒë¨ ===');
            console.log('íƒ€ì…:', type);
            console.log('ê°’:', value);
            
            selectedItem = value;
            startNodeType = type;
            
            // í•´ë‹¹ ì»¨í…Œì´ë„ˆì˜ ëª¨ë“  ë²„íŠ¼ì—ì„œ ì„ íƒ í•´ì œ
            const containerMap = {
                'product': 'productButtons',
                'material': 'materialButtons',
                'workcenter': 'workcenterButtons'
            };
            
            const container = document.getElementById(containerMap[type]);
            container.querySelectorAll('.item-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === value) {
                    btn.classList.add('selected');
                    console.log('ë²„íŠ¼ ì„ íƒ í‘œì‹œ:', btn.textContent);
                }
            });
            
            // ê·¸ë˜í”„ ë¡œë“œ - ì¦‰ì‹œ ì‹¤í–‰!
            console.log('ê·¸ë˜í”„ ë¡œë“œ ì‹œì‘...');
            try {
                await loadOrderGraph(value);
                console.log('ê·¸ë˜í”„ ë¡œë“œ ì™„ë£Œ!');
            } catch (error) {
                console.error('ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            await checkConnection();
            await loadFilters();
            await loadSummary();
            initGraph();
        }
        
        
        // API ì—°ê²° í™•ì¸
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/overview`);
                if (response.ok) {
                    document.getElementById('statusBadge').textContent = 'âœ“ ì—°ê²°ë¨';
                    document.getElementById('statusBadge').className = 'status connected';
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                document.getElementById('statusBadge').textContent = 'âœ— ì—°ê²° ëŠê¹€';
                document.getElementById('statusBadge').className = 'status disconnected';
                console.error('API ì—°ê²° ì‹¤íŒ¨:', error);
            }
        }
        
        // í•„í„° ì˜µì…˜ ë¡œë“œ
        async function loadFilters() {
            try {
                const response = await fetch(`${API_BASE}/filters`);
                const data = await response.json();
                
                console.log('í•„í„° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', data);
                
                // ì œí’ˆ ë²„íŠ¼ ìƒì„±
                const productContainer = document.getElementById('productButtons');
                productContainer.innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(p => {
                        const btn = document.createElement('button');
                        btn.className = 'item-btn';
                        btn.textContent = p;
                        btn.onclick = () => selectItem('product', p);
                        productContainer.appendChild(btn);
                    });
                    console.log(`${data.products.length}ê°œ ì œí’ˆ ë²„íŠ¼ ìƒì„± ì™„ë£Œ`);
                } else {
                    productContainer.innerHTML = '<div style="text-align: center; width: 100%; color: #999;">ì œí’ˆ ë°ì´í„° ì—†ìŒ</div>';
                }
                
                // ê³µì • ë²„íŠ¼ ìƒì„±
                const workcenterContainer = document.getElementById('workcenterButtons');
                workcenterContainer.innerHTML = '';
                
                if (data.work_centers && data.work_centers.length > 0) {
                    data.work_centers.forEach(wc => {
                        const btn = document.createElement('button');
                        btn.className = 'item-btn';
                        btn.textContent = wc;
                        btn.onclick = () => selectItem('workcenter', wc);
                        workcenterContainer.appendChild(btn);
                    });
                    console.log(`${data.work_centers.length}ê°œ ê³µì • ë²„íŠ¼ ìƒì„± ì™„ë£Œ`);
                } else {
                    workcenterContainer.innerHTML = '<div style="text-align: center; width: 100%; color: #999;">ê³µì • ë°ì´í„° ì—†ìŒ</div>';
                }
                
                // ì›ìì¬ ë²„íŠ¼ ìƒì„±
                const materialContainer = document.getElementById('materialButtons');
                materialContainer.innerHTML = '';
                
                if (data.materials && data.materials.length > 0) {
                    data.materials.slice(0, 30).forEach(m => {
                        const btn = document.createElement('button');
                        btn.className = 'item-btn';
                        btn.textContent = m.id;
                        btn.title = m.name;
                        btn.onclick = () => selectItem('material', m.id);
                        materialContainer.appendChild(btn);
                    });
                    console.log(`${Math.min(30, data.materials.length)}ê°œ ì›ìì¬ ë²„íŠ¼ ìƒì„± ì™„ë£Œ`);
                } else {
                    materialContainer.innerHTML = '<div style="text-align: center; width: 100%; color: #999;">ì›ìì¬ ë°ì´í„° ì—†ìŒ</div>';
                }
            } catch (error) {
                console.error('í•„í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('í•„í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ìš”ì•½ ì •ë³´ ë¡œë“œ
        async function loadSummary(filters = {}) {
            try {
                const response = await fetch(`${API_BASE}/filtered_summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                });
                const data = await response.json();
                
                // ì „ì²´ ì›ê°€ì°¨ì´
                document.getElementById('totalAmount').textContent = 
                    formatCurrency(data.total_variance);
                document.getElementById('totalCount').textContent = 
                    `${data.total_count}ê±´`;
                
                // ì›ê°€ ìš”ì†Œë³„ ê¸ˆì•¡ (ì¬ë£Œë¹„, ë…¸ë¬´ë¹„, ê²½ë¹„)
                const amounts = { MATERIAL: 0, LABOR: 0, OVERHEAD: 0 };
                
                data.by_type.forEach(item => {
                    const element = item.cost_element;
                    if (amounts.hasOwnProperty(element)) {
                        amounts[element] += parseFloat(item.total_variance || 0);
                    }
                });
                
                // ì¬ë£Œë¹„ì°¨ì´, ë…¸ë¬´ë¹„ì°¨ì´, ê²½ë¹„ì°¨ì´ë¡œ í‘œì‹œ
                document.getElementById('amountQuantity').textContent = 
                    formatCurrency(amounts.MATERIAL);
                document.getElementById('amountPrice').textContent = 
                    formatCurrency(amounts.LABOR);
                document.getElementById('amountProduction').textContent = 
                    formatCurrency(amounts.OVERHEAD);
                    
            } catch (error) {
                console.error('ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í•„í„° ì ìš© (ëª©ë¡ë§Œ í•„í„°ë§)
        async function applyFilters() {
            currentFilters = {
                month: document.getElementById('filterPeriod').value
            };
            
            await loadSummary(currentFilters);
            
            // í¼ì³ì§„ ì¹´í…Œê³ ë¦¬ ìƒˆë¡œê³ ì¹¨
            for (const category of expandedCategories) {
                await loadCategoryItems(category);
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ í† ê¸€
        async function toggleCategory(category) {
            const items = document.getElementById(`items${capitalize(category)}`);
            const icon = document.getElementById(`icon${capitalize(category)}`);
            
            if (expandedCategories.has(category)) {
                // ì ‘ê¸°
                items.classList.remove('show');
                icon.classList.remove('expanded');
                expandedCategories.delete(category);
            } else {
                // í¼ì¹˜ê¸°
                items.classList.add('show');
                icon.classList.add('expanded');
                expandedCategories.add(category);
                await loadCategoryItems(category);
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ í•­ëª© ë¡œë“œ
        async function loadCategoryItems(category) {
            const elementMap = {
                'quantity': 'MATERIAL',
                'price': 'LABOR',
                'production': 'OVERHEAD'
            };
            
            const costElement = elementMap[category];
            if (!costElement) {
                console.error('Unknown category:', category);
                return;
            }
            
            const container = document.getElementById(`items${capitalize(category)}`);
            container.innerHTML = '<div style="padding:10px; text-align:center; color:#7f8c8d; font-size:11px;">ë¡œë”©ì¤‘...</div>';
            
            try {
                // cost_elementë¡œ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`${API_BASE}/variances/by-element?element=${costElement}`);
                const allOrders = await response.json();
                
                // ì •ë ¬ (ì ˆëŒ€ê°’ ê¸°ì¤€)
                allOrders.sort((a, b) => Math.abs(b.total_variance) - Math.abs(a.total_variance));
                
                // HTML ìƒì„± - í•­ìƒ ìƒì‚°ì˜¤ë”ë³„ë¡œ í‘œì‹œ
                if (allOrders.length === 0) {
                    container.innerHTML = '<div style="padding:10px; text-align:center; color:#7f8c8d; font-size:11px;">ë°ì´í„° ì—†ìŒ</div>';
                } else {
                    // ìƒì‚°ì˜¤ë”ë³„ë¡œ í‘œì‹œ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                    container.innerHTML = allOrders.map(order => `
                        <div class="order-item" onclick="loadOrderGraphAsOrder('${order.order_no}', event)">
                            <div class="order-no">${order.order_no}</div>
                            <div class="order-detail">ì œí’ˆ: ${order.product || 'N/A'} | ê³µì •: ${order.work_center || 'N/A'}</div>
                            <div class="order-amount">${formatCurrency(order.total_variance)}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('í•­ëª© ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = '<div style="padding:10px; text-align:center; color:#e74c3c; font-size:11px;">ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }
        
        // ë…¸ë“œ ê·¸ë˜í”„ ë¡œë“œ (ë‹¤ì–‘í•œ íƒ€ì… ì§€ì›)
        async function loadOrderGraph(identifier, evt) {
            console.log('=== loadOrderGraph í˜¸ì¶œ ===');
            console.log('identifier:', identifier);
            console.log('startNodeType:', startNodeType);
            
            document.getElementById('loading').style.display = 'block';
            
            // íƒ€ì´í‹€ ì„¤ì •
            const titleMap = {
                'order': 'ìƒì‚°ì˜¤ë”',
                'product': 'ì œí’ˆ',
                'material': 'ì›ìì¬',
                'workcenter': 'ê³µì •'
            };
            document.getElementById('graphTitle').textContent = `${titleMap[startNodeType]}: ${identifier}`;
            
            // ì„ íƒ í‘œì‹œ
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('selected');
            });
            if (evt) {
                evt.target.closest('.order-item').classList.add('selected');
            }
            
            try {
                let response;
                const endpointMap = {
                    'order': `production-order/${encodeURIComponent(identifier)}`,
                    'product': `product/${encodeURIComponent(identifier)}`,
                    'material': `material/${encodeURIComponent(identifier)}`,
                    'workcenter': `workcenter/${encodeURIComponent(identifier)}`
                };
                
                const endpoint = `${API_BASE}/${endpointMap[startNodeType]}/graph`;
                console.log('API í˜¸ì¶œ:', endpoint);
                
                response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                console.log('Graph data received:', data);
                updateGraph(data.nodes, data.edges);
                
                // ì´ˆê¸° ìƒíƒœ ì €ì¥
                saveInitialState(data.nodes, data.edges);
            } catch (error) {
                console.error('ê·¸ë˜í”„ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ê·¸ë˜í”„ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ìƒì‚°ì˜¤ë”ë¡œ ê·¸ë˜í”„ ë¡œë“œ (ì•„ë˜ ëª©ë¡ì—ì„œ í´ë¦­ ì‹œ)
        async function loadOrderGraphAsOrder(orderNo, evt) {
            console.log('ìƒì‚°ì˜¤ë” í´ë¦­:', orderNo);
            // ì„ì‹œë¡œ startNodeTypeì„ orderë¡œ ë³€ê²½
            const originalType = startNodeType;
            startNodeType = 'order';
            await loadOrderGraph(orderNo, evt);
            startNodeType = originalType; // ì›ë˜ íƒ€ì…ìœ¼ë¡œ ë³µì›
        }
        
        // ê·¸ë˜í”„ ì´ˆê¸°í™”
        function initGraph() {
            console.log('Initializing graph...');
            const container = document.getElementById('mynetwork');
            
            if (!container) {
                console.error('Graph container not found!');
                return;
            }
            
            if (typeof vis === 'undefined') {
                console.error('vis.js library not loaded!');
                return;
            }
            
            nodes = new vis.DataSet([]);
            edges = new vis.DataSet([]);
            
            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'dot',
                    font: {
                        size: 12,
                        face: 'Segoe UI'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    smooth: { type: 'continuous' },
                    font: { size: 10, align: 'middle' }
                },
                physics: {
                    enabled: true,
                    stabilization: { 
                        enabled: true,
                        iterations: 200,
                        updateInterval: 50,
                        onlyDynamicEdges: false,
                        fit: true
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.1,
                        springLength: 150,
                        springConstant: 0.04,
                        damping: 0.7,
                        avoidOverlap: 0.3
                    },
                    maxVelocity: 30,
                    minVelocity: 0.1,
                    solver: 'barnesHut',
                    timestep: 0.5
                    solver: 'barnesHut'
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };
            
            network = new vis.Network(container, data, options);
            console.log('Network object created:', network);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            network.on('doubleClick', handleNodeDoubleClick);
            network.on('click', handleNodeClick);
            
            document.getElementById('loading').style.display = 'none';
            console.log('Graph initialized successfully');
        }
        
        // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
        function updateGraph(newNodes, newEdges) {
            console.log('Updating graph with nodes:', newNodes.length, 'edges:', newEdges.length);
            
            // ë„ˆë¬´ ë§ì€ ë…¸ë“œ ê²½ê³ 
            if (newNodes.length > 50) {
                console.warn('âš ï¸ ë…¸ë“œê°€ ë§ìŠµë‹ˆë‹¤ (' + newNodes.length + 'ê°œ). ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥.');
                document.getElementById('graphTitle').textContent += ' (ë…¸ë“œ ' + newNodes.length + 'ê°œ)';
            }
            
            const container = document.getElementById('mynetwork');
            console.log('Container size:', {
                width: container.offsetWidth,
                height: container.offsetHeight,
                display: window.getComputedStyle(container).display
            });
            
            nodes.clear();
            edges.clear();
            
            nodes.add(newNodes);
            edges.add(newEdges);
            
            console.log('Nodes added to dataset:', nodes.length);
            console.log('Edges added to dataset:', edges.length);
            
            // ë…¸ë“œ ìˆ˜ê°€ ë§ìœ¼ë©´ ë¬¼ë¦¬ ì—”ì§„ ë¹„í™œì„±í™”
            if (newNodes.length > 30) {
                network.setOptions({
                    physics: {
                        enabled: false
                    }
                });
                console.log('ë¬¼ë¦¬ ì—”ì§„ ë¹„í™œì„±í™” (ë…¸ë“œ ìˆ˜:', newNodes.length + ')');
            } else {
                network.setOptions({
                    physics: {
                        enabled: true
                    }
                });
            }
            
            // ê·¸ë˜í”„ë¥¼ í™”ë©´ì— ë§ì¶”ê³  ì•½ê°„ ì¤Œì•„ì›ƒ
            setTimeout(() => {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
                console.log('Network.fit() called, scale:', network.getScale());
                
                // ì•½ê°„ ì¤Œì•„ì›ƒí•˜ì—¬ ì „ì²´ê°€ ë³´ì´ë„ë¡
                setTimeout(() => {
                    const scale = network.getScale();
                    network.moveTo({
                        scale: scale * 0.8,
                        animation: {
                            duration: 500,
                            easingFunction: 'easeInOutQuad'
                        }
                    });
                    console.log('Zoomed out to scale:', scale * 0.8);
                }, 1000);
            }, 100);
            
            console.log('Graph updated successfully');
        }
        
        // ë…¸ë“œ ë”ë¸”í´ë¦­ - í™•ì¥
        async function handleNodeDoubleClick(params) {
            if (params.nodes.length === 0) return;
            
            const nodeId = params.nodes[0];
            document.getElementById('loading').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/node/${nodeId}/expand`);
                const data = await response.json();
                
                // ê¸°ì¡´ ë…¸ë“œ/ì—£ì§€ì— ì¶”ê°€
                data.nodes.forEach(node => {
                    if (!nodes.get(node.id)) {
                        nodes.add(node);
                    }
                });
                
                data.edges.forEach(edge => {
                    if (!edges.get(edge.id)) {
                        edges.add(edge);
                    }
                });
                
                document.getElementById('graphInfo').textContent = 
                    `${data.nodes.length}ê°œ ë…¸ë“œ ì¶”ê°€ë¨`;
                    
            } catch (error) {
                console.error('ë…¸ë“œ í™•ì¥ ì‹¤íŒ¨:', error);
                alert('ë…¸ë“œë¥¼ í™•ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ë…¸ë“œ í´ë¦­ - ì½˜ì†”ì— ì •ë³´ ì¶œë ¥
        function handleNodeClick(params) {
            if (params.nodes.length === 0) {
                return;
            }
            
            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            
            if (!node) return;
            
            // ì½˜ì†”ì—ë§Œ ì¶œë ¥
            console.log(`${node.type}: ${node.label}`, node.properties);
        }
        
        // ì´ˆê¸°í™” ë²„íŠ¼ - ì²˜ìŒ ìƒíƒœë¡œ
        let initialGraphData = null;
        
        function saveInitialState(graphNodes, graphEdges) {
            initialGraphData = {
                nodes: JSON.parse(JSON.stringify(graphNodes)),
                edges: JSON.parse(JSON.stringify(graphEdges))
            };
        }
        
        function resetToInitial() {
            if (!initialGraphData) {
                alert('ì´ˆê¸° ìƒíƒœê°€ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            nodes.clear();
            edges.clear();
            nodes.add(initialGraphData.nodes);
            edges.add(initialGraphData.edges);
            
            network.fit();
            document.getElementById('graphInfo').textContent = 'ê·¸ë˜í”„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤';
        }
        
        // í¬ì»¤ìŠ¤ ë²„íŠ¼ - ì„ íƒí•œ ë…¸ë“œë§Œ ë³´ê¸°
        function focusSelection() {
            const selected = network.getSelectedNodes();
            
            if (selected.length === 0) {
                alert('ë…¸ë“œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš” (í´ë¦­)');
                return;
            }
            
            const selectedNodeId = selected[0];
            const selectedNode = nodes.get(selectedNodeId);
            
            // ì„ íƒí•œ ë…¸ë“œì™€ ì§ì ‘ ì—°ê²°ëœ ë…¸ë“œ ì°¾ê¸°
            const connectedEdges = edges.get({
                filter: edge => edge.from === selectedNodeId || edge.to === selectedNodeId
            });
            
            const connectedNodeIds = new Set([selectedNodeId]);
            connectedEdges.forEach(edge => {
                connectedNodeIds.add(edge.from);
                connectedNodeIds.add(edge.to);
            });
            
            // ì—°ê²°ëœ ë…¸ë“œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ìˆ¨ê¸°ê¸°
            const allNodes = nodes.get();
            allNodes.forEach(node => {
                if (connectedNodeIds.has(node.id)) {
                    nodes.update({ id: node.id, hidden: false });
                } else {
                    nodes.update({ id: node.id, hidden: true });
                }
            });
            
            const allEdges = edges.get();
            allEdges.forEach(edge => {
                if (connectedNodeIds.has(edge.from) && connectedNodeIds.has(edge.to)) {
                    edges.update({ id: edge.id, hidden: false });
                } else {
                    edges.update({ id: edge.id, hidden: true });
                }
            });
            
            setTimeout(() => {
                network.fit();
            }, 100);
            
            document.getElementById('graphInfo').textContent = `${selectedNode.label} ì¤‘ì‹¬ìœ¼ë¡œ í¬ì»¤ìŠ¤`;
        }
        
        // ìœ í‹¸ë¦¬í‹°
        function formatCurrency(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0
            }).format(num);
        }
        
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // ì‹œì‘
        init();
    </script>
</body>
</html>
